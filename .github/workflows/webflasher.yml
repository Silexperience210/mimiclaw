name: Build & Update Web Flasher

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: webflasher
  cancel-in-progress: false

jobs:
  build-and-commit:
    runs-on: ubuntu-latest
    container:
      image: espressif/idf:v5.5.2

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build v1 (sans ecran)
        shell: bash
        run: |
          . $IDF_PATH/export.sh
          idf.py set-target esp32s3
          idf.py build
          mkdir -p docs/firmware/v1
          cp build/bootloader/bootloader.bin           docs/firmware/v1/
          cp build/partition_table/partition-table.bin  docs/firmware/v1/
          cp build/ota_data_initial.bin                 docs/firmware/v1/
          cp build/mimiclaw.bin                         docs/firmware/v1/

      - name: Build v1.2 (avec ecran T-Display S3)
        shell: bash
        run: |
          . $IDF_PATH/export.sh
          idf.py fullclean
          echo "CONFIG_MIMI_HAS_DISPLAY=y" >> sdkconfig.defaults
          idf.py set-target esp32s3
          idf.py build
          mkdir -p docs/firmware/v1.2
          cp build/bootloader/bootloader.bin           docs/firmware/v1.2/
          cp build/partition_table/partition-table.bin  docs/firmware/v1.2/
          cp build/ota_data_initial.bin                 docs/firmware/v1.2/
          cp build/mimiclaw.bin                         docs/firmware/v1.2/

      - name: Build v1.3 (ecran + HC-SR04 + servos)
        shell: bash
        run: |
          . $IDF_PATH/export.sh
          idf.py fullclean
          # Repartir de sdkconfig.defaults propre
          git checkout sdkconfig.defaults
          printf "CONFIG_MIMI_HAS_DISPLAY=y\nCONFIG_MIMI_HAS_SERVOS=y\n" >> sdkconfig.defaults
          idf.py set-target esp32s3
          idf.py build
          mkdir -p docs/firmware/v1.3
          cp build/bootloader/bootloader.bin           docs/firmware/v1.3/
          cp build/partition_table/partition-table.bin  docs/firmware/v1.3/
          cp build/ota_data_initial.bin                 docs/firmware/v1.3/
          cp build/mimiclaw.bin                         docs/firmware/v1.3/

      - name: Generate manifests
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME:-dev}"
          python3 -c "
          import json
          variants = [
              ('v1',   'LilyClaw v1 (sans ecran)'),
              ('v1.2', 'LilyClaw v1.2 (T-Display S3 + ecran)'),
              ('v1.3', 'LilyClaw v1.3 (ecran + HC-SR04 + servos)'),
          ]
          for v, name in variants:
              m = {
                  'name': name,
                  'version': '$VERSION',
                  'new_install_prompt_erase': True,
                  'builds': [{
                      'chipFamily': 'ESP32-S3',
                      'parts': [
                          {'path': f'firmware/{v}/bootloader.bin', 'offset': 0},
                          {'path': f'firmware/{v}/partition-table.bin', 'offset': 32768},
                          {'path': f'firmware/{v}/ota_data_initial.bin', 'offset': 61440},
                          {'path': f'firmware/{v}/mimiclaw.bin', 'offset': 131072}
                      ]
                  }]
              }
              with open(f'docs/manifest-{v}.json', 'w') as f:
                  json.dump(m, f, indent=2)
                  f.write('\n')
          "

      - name: Commit and push firmware binaries
        shell: bash
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -f docs/firmware/ docs/manifest-v1.json docs/manifest-v1.2.json docs/manifest-v1.3.json
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "chore: update firmware v1 + v1.2 + v1.3 (${GITHUB_REF_NAME:-manual})"
          git pull --rebase origin main || true
          git push origin HEAD:main
