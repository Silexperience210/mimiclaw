name: Build & Update Web Flasher

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-commit:
    runs-on: ubuntu-latest
    container:
      image: espressif/idf:v5.5.2

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build firmware
        shell: bash
        run: |
          . $IDF_PATH/export.sh
          idf.py set-target esp32s3
          idf.py build

      - name: Copy binaries to docs/firmware
        shell: bash
        run: |
          mkdir -p docs/firmware
          cp build/bootloader/bootloader.bin           docs/firmware/
          cp build/partition_table/partition-table.bin  docs/firmware/
          cp build/ota_data_initial.bin                 docs/firmware/
          cp build/mimiclaw.bin                         docs/firmware/

      - name: Update manifest version
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME:-dev}"
          cat > docs/manifest.json << 'ENDMANIFEST'
          {
            "name": "LilyClaw (MimiClaw for T-Display S3)",
            "version": "VERSION_PLACEHOLDER",
            "new_install_prompt_erase": true,
            "builds": [
              {
                "chipFamily": "ESP32-S3",
                "parts": [
                  { "path": "firmware/bootloader.bin", "offset": 0 },
                  { "path": "firmware/partition-table.bin", "offset": 32768 },
                  { "path": "firmware/ota_data_initial.bin", "offset": 61440 },
                  { "path": "firmware/mimiclaw.bin", "offset": 131072 }
                ]
              }
            ]
          }
          ENDMANIFEST
          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/" docs/manifest.json

      - name: Commit and push firmware binaries
        shell: bash
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/firmware/ docs/manifest.json
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "chore: update web flasher firmware binaries (${GITHUB_REF_NAME:-manual})"
          git push origin HEAD:main
