name: Build & Update Web Flasher

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: webflasher
  cancel-in-progress: false

jobs:
  # ── Job 1 : compiler les 3 variantes EN PARALLELE ──
  build:
    runs-on: ubuntu-latest
    container:
      image: espressif/idf:v5.5.2

    strategy:
      matrix:
        include:
          - variant: v1
            label: "Base (sans ecran)"
            sdkconfig_extra: ""
          - variant: v1.2
            label: "Display (T-Display S3)"
            sdkconfig_extra: "CONFIG_MIMI_HAS_DISPLAY=y"
          - variant: v1.3
            label: "Full (ecran + HC-SR04 + servos)"
            sdkconfig_extra: "CONFIG_MIMI_HAS_DISPLAY=y\nCONFIG_MIMI_HAS_SERVOS=y"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build ${{ matrix.variant }} (${{ matrix.label }})
        shell: bash
        run: |
          . $IDF_PATH/export.sh
          if [ -n "${{ matrix.sdkconfig_extra }}" ]; then
            printf "${{ matrix.sdkconfig_extra }}" >> sdkconfig.defaults
          fi
          idf.py set-target esp32s3
          idf.py build

      - name: Upload firmware ${{ matrix.variant }}
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.variant }}
          path: |
            build/bootloader/bootloader.bin
            build/partition_table/partition-table.bin
            build/ota_data_initial.bin
            build/mimiclaw.bin
          retention-days: 1

  # ── Job 2 : assembler et pousser les firmwares ──
  commit:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all firmware artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Assemble firmware directory
        shell: bash
        run: |
          for variant in v1 v1.2 v1.3; do
            mkdir -p docs/firmware/$variant
            cp artifacts/firmware-$variant/build/bootloader/bootloader.bin          docs/firmware/$variant/
            cp artifacts/firmware-$variant/build/partition_table/partition-table.bin docs/firmware/$variant/
            cp artifacts/firmware-$variant/build/ota_data_initial.bin               docs/firmware/$variant/
            cp artifacts/firmware-$variant/build/mimiclaw.bin                       docs/firmware/$variant/
          done

      - name: Generate manifests
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME:-dev}"
          python3 -c "
          import json
          variants = [
              ('v1',   'LilyClaw Base (sans ecran)'),
              ('v1.2', 'LilyClaw Display (T-Display S3)'),
              ('v1.3', 'LilyClaw Full (ecran + HC-SR04 + servos)'),
          ]
          for v, name in variants:
              m = {
                  'name': name,
                  'version': '$VERSION',
                  'new_install_prompt_erase': True,
                  'builds': [{
                      'chipFamily': 'ESP32-S3',
                      'parts': [
                          {'path': f'firmware/{v}/bootloader.bin', 'offset': 0},
                          {'path': f'firmware/{v}/partition-table.bin', 'offset': 32768},
                          {'path': f'firmware/{v}/ota_data_initial.bin', 'offset': 61440},
                          {'path': f'firmware/{v}/mimiclaw.bin', 'offset': 131072}
                      ]
                  }]
              }
              with open(f'docs/manifest-{v}.json', 'w') as f:
                  json.dump(m, f, indent=2)
                  f.write('\n')
          "

      - name: Commit and push firmware binaries
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Se baser sur le dernier main
          git fetch origin main
          git reset --soft origin/main

          git add -f docs/firmware/ docs/manifest-v1.json docs/manifest-v1.2.json docs/manifest-v1.3.json
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "chore: update firmware Base + Display + Full (${GITHUB_REF_NAME:-manual})"
          git push origin HEAD:main
